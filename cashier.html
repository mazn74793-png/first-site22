<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cashier</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{background:linear-gradient(135deg,#0b1220,#0b1a2a);}
  </style>
</head>

<body class="min-h-screen text-white">
  <div class="max-w-3xl mx-auto px-4 pt-6">

    <!-- Top bar -->
    <div class="flex items-center justify-between">
      <a href="./index.html" class="px-4 py-2 rounded-xl bg-white/10 border border-white/10">Ø±Ø¬ÙˆØ¹</a>

      <div class="text-right">
        <div class="text-xl font-bold">ğŸ§¾ ÙƒØ§Ø´ÙŠØ±</div>
        <div class="text-white/70 text-sm">ØªØ¬Ø±Ø¨Ø© ØªØ¹Ù„ÙŠÙ…ÙŠØ©</div>
      </div>

      <button id="logoutBtn" class="px-4 py-2 rounded-xl bg-red-500/20 border border-red-500/30 text-red-200">
        Ø®Ø±ÙˆØ¬
      </button>
    </div>

    <!-- Add item card -->
    <div class="mt-6 p-5 rounded-3xl bg-white/5 border border-white/10 backdrop-blur">
      <div class="text-lg font-bold mb-2">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ù„Ù„Ø³Ù„Ø©</div>
      <div class="text-white/70 text-sm mb-4">Ø§ÙƒØªØ¨ ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬ ÙˆØ§Ø¶ØºØ· "Ø¨Ø­Ø«" Ø«Ù… Ø§Ø®ØªØ± Ø§Ù„ÙƒÙ…ÙŠØ© ÙˆØ§Ø¶ØºØ· "Ø¥Ø¶Ø§ÙØ©"</div>

      <div class="grid gap-3">
        <input id="code" class="w-full p-4 rounded-2xl bg-black/20 border border-white/10 outline-none" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬ (Ù…Ø«Ø§Ù„: 1001)" />
        <input id="qty" type="number" min="1" value="1" class="w-full p-4 rounded-2xl bg-black/20 border border-white/10 outline-none" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©" />
      </div>

      <div class="mt-4 flex gap-3">
        <button id="findBtn" class="flex-1 p-4 rounded-2xl bg-blue-500 hover:bg-blue-600 font-bold">Ø¨Ø­Ø«</button>
        <button id="addBtn" class="flex-1 p-4 rounded-2xl bg-white/10 border border-white/10">Ø¥Ø¶Ø§ÙØ©</button>
      </div>

      <div id="found" class="mt-4 text-center text-sm text-white/80"></div>
      <div id="msg" class="mt-2 text-center text-sm"></div>
    </div>

    <!-- Cart -->
    <div class="mt-6 p-5 rounded-3xl bg-white/5 border border-white/10 backdrop-blur">
      <div class="flex items-center justify-between mb-3">
        <div class="text-lg font-bold">Ø§Ù„Ø³Ù„Ø©</div>
        <div class="text-white/70 text-sm">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="total">0</span> Ø¬Ù†ÙŠÙ‡</div>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="text-white/70">
            <tr class="border-b border-white/10">
              <th class="py-3 text-right">Ø§Ù„ÙƒÙˆØ¯</th>
              <th class="py-3 text-right">Ø§Ù„Ø§Ø³Ù…</th>
              <th class="py-3 text-right">Ø§Ù„Ø³Ø¹Ø±</th>
              <th class="py-3 text-right">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
              <th class="py-3 text-right">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
              <th class="py-3 text-right">Ø­Ø°Ù</th>
            </tr>
          </thead>
          <tbody id="rows">
            <tr><td colspan="6" class="py-6 text-center text-white/60">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø¶ÙŠØ©</td></tr>
          </tbody>
        </table>
      </div>

      <div class="mt-4 flex gap-3">
        <button id="confirmBtn" class="flex-1 p-4 rounded-2xl bg-blue-500 hover:bg-blue-600 font-bold">ØªØ£ÙƒÙŠØ¯</button>
        <button id="clearBtn" class="flex-1 p-4 rounded-2xl bg-white/10 border border-white/10">ØªÙØ±ÙŠØº</button>
      </div>

      <div class="mt-3 text-center text-xs text-white/60">
        * Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ù‡Ù†Ø§ Ø¨ÙŠØ¹Ù…Ù„ ÙØ§ØªÙˆØ±Ø© + ÙŠØ®ØµÙ… Ù…Ø®Ø²ÙˆÙ† (ÙØ¹Ù„ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Supabase)
      </div>
    </div>

    <div class="h-10"></div>
  </div>

  <!-- Must exist -->
  <script src="./supabase.js"></script>

  <script>
    const sb = window.supabaseClient || window.supabase;

    const msg = document.getElementById("msg");
    const found = document.getElementById("found");
    const rowsEl = document.getElementById("rows");
    const totalEl = document.getElementById("total");

    const codeEl = document.getElementById("code");
    const qtyEl = document.getElementById("qty");

    let session = null;
    let lastFoundProduct = null;

    // cart: key = product_id
    const cart = new Map();

    function setMsg(text, ok=true){
      msg.className = "mt-2 text-center text-sm " + (ok ? "text-green-200" : "text-red-300");
      msg.textContent = text || "";
    }

    function setFound(text, ok=true){
      found.className = "mt-4 text-center text-sm " + (ok ? "text-green-200" : "text-red-300");
      found.textContent = text || "";
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    async function requireAuth(){
      const { data } = await sb.auth.getSession();
      if(!data.session){
        location.href = "./login.html";
        return null;
      }
      session = data.session;
      return session;
    }

    function renderCart(){
      const items = Array.from(cart.values());
      if(items.length === 0){
        rowsEl.innerHTML = `<tr><td colspan="6" class="py-6 text-center text-white/60">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø¶ÙŠØ©</td></tr>`;
        totalEl.textContent = "0";
        return;
      }

      let total = 0;
      rowsEl.innerHTML = "";
      for(const it of items){
        const line = Number(it.price) * Number(it.qty);
        total += line;

        const tr = document.createElement("tr");
        tr.className = "border-b border-white/10";
        tr.innerHTML = `
          <td class="py-3">${escapeHtml(it.code)}</td>
          <td class="py-3">${escapeHtml(it.name)}</td>
          <td class="py-3">${Number(it.price)}</td>
          <td class="py-3">
            <input type="number" min="1" class="w-20 p-2 rounded-xl bg-black/20 border border-white/10 outline-none"
              value="${Number(it.qty)}" data-qty="${it.product_id}">
          </td>
          <td class="py-3">${line}</td>
          <td class="py-3">
            <button class="px-3 py-2 rounded-xl bg-red-500/20 border border-red-500/30 text-red-200" data-del="${it.product_id}">Ø­Ø°Ù</button>
          </td>
        `;
        rowsEl.appendChild(tr);
      }

      totalEl.textContent = String(total);

      // bind qty change
      rowsEl.querySelectorAll("[data-qty]").forEach(inp=>{
        inp.addEventListener("input", ()=>{
          const id = inp.getAttribute("data-qty");
          const v = Math.max(1, Number(inp.value || 1));
          const it = cart.get(id);
          if(it){
            it.qty = v;
            cart.set(id, it);
            renderCart();
          }
        });
      });

      // bind delete
      rowsEl.querySelectorAll("[data-del]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.getAttribute("data-del");
          cart.delete(id);
          renderCart();
        });
      });
    }

    async function findProduct(){
      setMsg("");
      setFound("");

      const code = (codeEl.value || "").trim();
      if(!code){
        setFound("Ø§ÙƒØªØ¨ ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬.", false);
        return;
      }

      // make sure auth exists
      await requireAuth();

      const { data, error } = await sb
        .from("products")
        .select("id,code,name,price,stock")
        .eq("code", code)
        .single();

      if(error){
        lastFoundProduct = null;
        setFound("Ù…Ø´ Ù„Ø§Ù‚ÙŠ Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø§Ù„ÙƒÙˆØ¯ Ø¯Ù‡.", false);
        return;
      }

      lastFoundProduct = data;
      setFound(`âœ… ${data.name} â€” Ø§Ù„Ø³Ø¹Ø±: ${Number(data.price)} Ø¬Ù†ÙŠÙ‡ â€” Ø§Ù„Ù…Ø®Ø²ÙˆÙ†: ${Number(data.stock)}`);
    }

    function addToCart(){
      setMsg("");
      if(!lastFoundProduct){
        setMsg("Ø§Ø¹Ù…Ù„ Ø¨Ø­Ø« Ø§Ù„Ø£ÙˆÙ„.", false);
        return;
      }

      const q = Math.max(1, Number(qtyEl.value || 1));
      const stock = Number(lastFoundProduct.stock || 0);

      if(q > stock){
        setMsg(`Ø§Ù„ÙƒÙ…ÙŠØ© Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (Ø§Ù„Ù…ØªØ§Ø­: ${stock}).`, false);
        return;
      }

      const id = String(lastFoundProduct.id);
      const existing = cart.get(id);
      const newQty = (existing ? existing.qty : 0) + q;

      if(newQty > stock){
        setMsg(`Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙÙŠ Ø§Ù„Ø³Ù„Ø© Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (Ø§Ù„Ù…ØªØ§Ø­: ${stock}).`, false);
        return;
      }

      cart.set(id, {
        product_id: id,
        code: lastFoundProduct.code,
        name: lastFoundProduct.name,
        price: Number(lastFoundProduct.price || 0),
        qty: newQty
      });

      setMsg("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© âœ…");
      renderCart();
    }

    async function confirm(){
      setMsg("");

      const items = Array.from(cart.values());
      if(items.length === 0){
        setMsg("Ø§Ù„Ø³Ù„Ø© ÙØ§Ø¶ÙŠØ©.", false);
        return;
      }

      await requireAuth();

      // Calculate total
      const total = items.reduce((s,it)=> s + (Number(it.price)*Number(it.qty)), 0);

      // 1) Create invoice
      const invoicePayload = {
        user_id: session.user.id,
        total: total
      };

      const invRes = await sb.from("invoices").insert(invoicePayload).select("id").single();
      if(invRes.error){
        setMsg("ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©: " + invRes.error.message, false);
        return;
      }
      const invoiceId = invRes.data.id;

      // 2) Create invoice items
      const itemsPayload = items.map(it => ({
        user_id: session.user.id,
        invoice_id: invoiceId,
        product_id: it.product_id,
        code: it.code,
        name: it.name,
        price: Number(it.price),
        qty: Number(it.qty),
        line_total: Number(it.price) * Number(it.qty)
      }));

      const itemsRes = await sb.from("invoice_items").insert(itemsPayload);
      if(itemsRes.error){
        setMsg("ÙØ´Ù„ Ø­ÙØ¸ Ø¨Ù†ÙˆØ¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø©: " + itemsRes.error.message, false);
        return;
      }

      // 3) Deduct stock (one-by-one to keep it simple)
      for(const it of items){
        // get current stock to be safe
        const pRes = await sb.from("products").select("id,stock").eq("id", it.product_id).single();
        if(pRes.error){
          setMsg("ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†: " + pRes.error.message, false);
          return;
        }
        const current = Number(pRes.data.stock || 0);
        const next = current - Number(it.qty);
        if(next < 0){
          setMsg(`Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø®Ù„Øµ Ù„Ù„Ù…Ù†ØªØ¬ ${it.code}.`, false);
          return;
        }

        const uRes = await sb.from("products")
          .update({ user_id: session.user.id, stock: next })
          .eq("id", it.product_id);

        if(uRes.error){
          setMsg("ÙØ´Ù„ Ø®ØµÙ… Ø§Ù„Ù…Ø®Ø²ÙˆÙ†: " + uRes.error.message, false);
          return;
        }
      }

      cart.clear();
      renderCart();
      setMsg("âœ… ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙˆØ®ØµÙ… Ø§Ù„Ù…Ø®Ø²ÙˆÙ†!");
      setFound("");
      lastFoundProduct = null;
      codeEl.value = "";
      qtyEl.value = 1;
    }

    document.getElementById("findBtn").addEventListener("click", findProduct);
    document.getElementById("addBtn").addEventListener("click", addToCart);
    document.getElementById("clearBtn").addEventListener("click", ()=>{
      cart.clear();
      renderCart();
      setMsg("ØªÙ… ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø©.");
    });
    document.getElementById("confirmBtn").addEventListener("click", confirm);

    document.getElementById("logoutBtn").addEventListener("click", async ()=>{
      await sb.auth.signOut();
      location.href = "./login.html";
    });

    // init
    (async ()=>{
      await requireAuth();
      renderCart();
    })();
  </script>
</body>
</html>
