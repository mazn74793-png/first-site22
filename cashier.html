<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ø§Ù„ÙƒØ§Ø´ÙŠØ±</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{background:linear-gradient(135deg,#0b1220,#0b1a2a);}
  </style>
</head>

<body class="min-h-screen text-white">
  <div class="max-w-3xl mx-auto px-4 pt-6">

    <!-- Top bar -->
    <div class="flex items-center justify-between">
      <a href="./products.html" class="px-4 py-2 rounded-xl bg-white/10 border border-white/10">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a>

      <div class="text-right">
        <div class="text-xl font-bold">ğŸ§¾ Ø§Ù„ÙƒØ§Ø´ÙŠØ±</div>
        <div class="text-white/70 text-sm">Ø¨Ø­Ø« â†’ Ø¥Ø¶Ø§ÙØ© â†’ ØªØ£ÙƒÙŠØ¯</div>
      </div>

      <button id="logoutBtn" class="px-4 py-2 rounded-xl bg-red-500/20 border border-red-500/30 text-red-200">
        Ø®Ø±ÙˆØ¬
      </button>
    </div>

    <!-- Search -->
    <div class="mt-6 p-5 rounded-3xl bg-white/5 border border-white/10 backdrop-blur">
      <div class="text-lg font-bold mb-2">Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬</div>

      <div class="grid gap-3">
        <input id="code" class="w-full p-4 rounded-2xl bg-black/20 border border-white/10 outline-none" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬ (Ø±Ù‚Ù…)" />
        <input id="qty" type="number" min="1" value="1" class="w-full p-4 rounded-2xl bg-black/20 border border-white/10 outline-none" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©" />
      </div>

      <div class="mt-4 flex gap-3">
        <button id="findBtn" class="flex-1 p-4 rounded-2xl bg-blue-500 hover:bg-blue-600 font-bold">Ø¨Ø­Ø«</button>
        <button id="addBtn" class="flex-1 p-4 rounded-2xl bg-white/10 border border-white/10">Ø¥Ø¶Ø§ÙØ©</button>
      </div>

      <div id="found" class="mt-4 text-center text-sm"></div>
      <div id="msg" class="mt-2 text-center text-sm"></div>
    </div>

    <!-- Cart -->
    <div class="mt-6 p-5 rounded-3xl bg-white/5 border border-white/10 backdrop-blur">
      <div class="flex items-center justify-between mb-3">
        <div class="text-lg font-bold">Ø§Ù„Ø³Ù„Ø©</div>
        <div class="text-white/70 text-sm">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="total">0</span> Ø¬Ù†ÙŠÙ‡</div>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="text-white/70">
            <tr class="border-b border-white/10">
              <th class="py-3 text-right">Ø§Ù„ÙƒÙˆØ¯</th>
              <th class="py-3 text-right">Ø§Ù„Ø§Ø³Ù…</th>
              <th class="py-3 text-right">Ø§Ù„Ø³Ø¹Ø±</th>
              <th class="py-3 text-right">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
              <th class="py-3 text-right">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
              <th class="py-3 text-right">Ø­Ø°Ù</th>
            </tr>
          </thead>
          <tbody id="rows">
            <tr><td colspan="6" class="py-6 text-center text-white/60">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø¶ÙŠØ©</td></tr>
          </tbody>
        </table>
      </div>

      <div class="mt-4 flex gap-3">
        <button id="confirmBtn" class="flex-1 p-4 rounded-2xl bg-green-500 hover:bg-green-600 font-bold">ØªØ£ÙƒÙŠØ¯</button>
        <button id="clearBtn" class="flex-1 p-4 rounded-2xl bg-white/10 border border-white/10">ØªÙØ±ÙŠØº</button>
      </div>
    </div>

    <div class="h-10"></div>
  </div>

  <!-- Supabase client -->
  <script src="./supabase.js"></script>

  <script>
    const sb = window.supabaseClient || window.supabase;

    const codeEl = document.getElementById("code");
    const qtyEl = document.getElementById("qty");
    const found = document.getElementById("found");
    const msg = document.getElementById("msg");
    const rowsEl = document.getElementById("rows");
    const totalEl = document.getElementById("total");

    let session = null;
    let lastFound = null;
    const cart = new Map();

    function ok(el, t){ el.className="mt-4 text-center text-sm text-green-300"; el.textContent=t||""; }
    function err(el, t){ el.className="mt-4 text-center text-sm text-red-300"; el.textContent=t||""; }

    async function requireAuth(){
      const { data } = await sb.auth.getSession();
      if(!data.session){
        location.href = "./login.html";
        return null;
      }
      session = data.session;
      return session;
    }

    function renderCart(){
      const items = Array.from(cart.values());
      if(items.length === 0){
        rowsEl.innerHTML = `<tr><td colspan="6" class="py-6 text-center text-white/60">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø¶ÙŠØ©</td></tr>`;
        totalEl.textContent = "0";
        return;
      }
      let total = 0;
      rowsEl.innerHTML = "";
      items.forEach(it=>{
        const line = it.price * it.qty;
        total += line;
        const tr = document.createElement("tr");
        tr.className="border-b border-white/10";
        tr.innerHTML = `
          <td class="py-3">${it.code}</td>
          <td class="py-3">${it.name}</td>
          <td class="py-3">${it.price}</td>
          <td class="py-3">${it.qty}</td>
          <td class="py-3">${line}</td>
          <td class="py-3"><button data-del="${it.product_id}" class="text-red-300">Ø­Ø°Ù</button></td>
        `;
        rowsEl.appendChild(tr);
      });
      totalEl.textContent = String(total);

      rowsEl.querySelectorAll("[data-del]").forEach(b=>{
        b.onclick = ()=>{ cart.delete(b.dataset.del); renderCart(); };
      });
    }

    async function findProduct(){
      ok(found,"");
      err(msg,"");
      const code = codeEl.value.trim();
      if(!code){ err(found,"Ø§ÙƒØªØ¨ ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬"); return; }

      await requireAuth();

      const { data, error } = await sb
        .from("products")
        .select("id,code,name,price,stock")
        .eq("code", Number(code))   // Ù…Ù‡Ù… Ø¬Ø¯Ù‹Ø§
        .single();

      if(error || !data){
        lastFound = null;
        err(found,"âŒ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
        return;
      }

      lastFound = data;
      ok(found,`âœ… ${data.name} | Ø§Ù„Ø³Ø¹Ø± ${data.price} | Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ${data.stock}`);
    }

    function addToCart(){
      err(msg,"");
      if(!lastFound){ err(msg,"Ù„Ø§Ø²Ù… ØªØ¨Ø­Ø« Ø§Ù„Ø£ÙˆÙ„"); return; }

      const q = Math.max(1, Number(qtyEl.value||1));
      if(q > lastFound.stock){ err(msg,"Ø§Ù„ÙƒÙ…ÙŠØ© Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ†"); return; }

      const id = String(lastFound.id);
      const ex = cart.get(id);
      const newQty = (ex?ex.qty:0) + q;
      if(newQty > lastFound.stock){ err(msg,"Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ†"); return; }

      cart.set(id,{
        product_id:id,
        code:lastFound.code,
        name:lastFound.name,
        price:Number(lastFound.price),
        qty:newQty
      });
      ok(msg,"ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©");
      renderCart();
      lastFound=null; codeEl.value=""; qtyEl.value=1;
    }

    async function confirm(){
      err(msg,"");
      const items = Array.from(cart.values());
      if(items.length===0){ err(msg,"Ø§Ù„Ø³Ù„Ø© ÙØ§Ø¶ÙŠØ©"); return; }

      await requireAuth();

      const total = items.reduce((s,i)=>s+i.price*i.qty,0);

      const inv = await sb.from("invoices")
        .insert({ user_id: session.user.id, total })
        .select("id").single();

      if(inv.error){ err(msg,inv.error.message); return; }

      const invoice_id = inv.data.id;

      const itemsPayload = items.map(i=>({
        user_id: session.user.id,
        invoice_id,
        product_id:i.product_id,
        code:i.code,
        name:i.name,
        price:i.price,
        qty:i.qty,
        line_total:i.price*i.qty
      }));

      const itRes = await sb.from("invoice_items").insert(itemsPayload);
      if(itRes.error){ err(msg,itRes.error.message); return; }

      for(const i of items){
        const p = await sb.from("products").select("stock").eq("id",i.product_id).single();
        if(p.error){ err(msg,p.error.message); return; }
        const newStock = p.data.stock - i.qty;
        const u = await sb.from("products").update({ stock:newStock }).eq("id",i.product_id);
        if(u.error){ err(msg,u.error.message); return; }
      }

      cart.clear();
      renderCart();
      ok(msg,"âœ… ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯ ÙˆØ®ØµÙ… Ø§Ù„Ù…Ø®Ø²ÙˆÙ†");
    }

    document.getElementById("findBtn").onclick = findProduct;
    document.getElementById("addBtn").onclick = addToCart;
    document.getElementById("confirmBtn").onclick = confirm;
    document.getElementById("clearBtn").onclick = ()=>{ cart.clear(); renderCart(); };
    document.getElementById("logoutBtn").onclick = async ()=>{ await sb.auth.signOut(); location.href="./login.html"; };

    requireAuth();
  </script>
</body>
</html> 
